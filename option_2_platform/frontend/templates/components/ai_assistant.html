<div class="review-assistant h-full flex flex-col bg-gray-50" x-data="{ 
    activeView: 'chat', 
    showConfirmation: false,
    criteria: [
        { id: 'K001', title: 'Betriebsstätte Hamburg', desc: 'Der Antragsteller muss eine Betriebsstätte in Hamburg nachweisen.', status: 'success', statusText: 'Erfüllt', checked: true },
        { id: 'K002', title: 'KMU-Status', desc: 'Unternehmen muss KMU-Kriterien erfüllen (Mitarbeiter, Umsatz).', status: 'success', statusText: 'Erfüllt', checked: true },
        { id: 'K003', title: 'Innovationsgehalt', desc: 'Das Vorhaben muss einen deutlichen Innovationsgehalt aufweisen.', status: 'warning', statusText: 'Prüfung', checked: false },
        { id: 'K004', title: 'Finanzielle Machbarkeit', desc: 'Gesamtfinanzierung muss gesichert sein.', status: 'pending', statusText: 'Offen', checked: false },
        { id: 'K005', title: 'Marktpotenzial', desc: 'Verwertungschancen und Zielmarkt müssen plausibel sein.', status: 'pending', statusText: 'Offen', checked: false },
        { id: 'K006', title: 'Qualifikation', desc: 'Das Team muss über notwendige Qualifikationen verfügen.', status: 'pending', statusText: 'Offen', checked: false }
    ],
    confirmReview() {
        // Logic to update project status would go here (HTMX request likely)
        // For visual feedback:
        htmx.ajax('POST', '/projects/{{ project.id }}/complete_review', {swap: 'none'});
        this.showConfirmation = false;
        // Optional: show toast
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-5 right-5 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-bounce';
        toast.innerText = 'Prüfung erfolgreich abgeschlossen!';
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 3000);
    }
}">

    <!-- Header Bar: Toggle Switch -->
    <div
        class="flex items-center justify-between px-4 py-3 bg-white border-b border-gray-200 flex-none z-10 transition-all duration-300">
        <div class="flex items-center gap-2">
            <h2 class="text-sm font-semibold text-gray-700"
                x-text="activeView === 'chat' ? 'AI Assistent' : 'Kriterienkatalog'"></h2>
            <template x-if="activeView === 'chat'">
                {% if model_name %}
                <span class="text-[10px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full border border-gray-200">{{
                    model_name }}</span>
                {% endif %}
            </template>
        </div>

        <!-- Toggle Button -->
        <button @click="activeView = activeView === 'chat' ? 'catalog' : 'chat'"
            class="group flex items-center gap-2 px-3 py-1.5 rounded-full text-xs font-medium transition-all duration-200 border"
            :class="activeView === 'chat' 
                ? 'bg-white border-gray-200 text-gray-600 hover:bg-gray-50 hover:border-gray-300' 
                : 'bg-primary-600 border-transparent text-white hover:bg-primary-700'">

            <span x-text="activeView === 'chat' ? 'Kriterienkatalog öffnen' : 'Zurück zum Assistant'"></span>
            <svg x-show="activeView === 'chat'" class="w-3.5 h-3.5 text-gray-400 group-hover:text-gray-600" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
            <svg x-show="activeView === 'catalog'" class="w-3.5 h-3.5 text-white" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
        </button>
    </div>

    <!-- VIEW 1: CHAT ASSISTANT -->
    <div x-show="activeView === 'chat'" class="flex-1 flex flex-col h-full overflow-hidden relative"
        x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0"
        x-transition:enter-end="opacity-100">

        <!-- Quick Action Bar -->
        <div
            class="px-4 py-3 bg-white border-b border-gray-200 flex gap-2 overflow-x-auto flex-none shadow-sm z-10 scrollbar-hide">
            <button
                class="flex items-center gap-2 px-3 py-1.5 text-xs font-medium text-white bg-primary-600 rounded-full hover:bg-primary-700 whitespace-nowrap transition-colors flex-shrink-0"
                hx-post="/projects/{{ project.id }}/analyze" hx-target="#chat-messages" hx-swap="beforeend"
                hx-indicator="#thinking-indicator"
                hx-on::after-request="document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Alle Kriterien prüfen
            </button>
            <button
                class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200 whitespace-nowrap transition-colors flex-shrink-0 border border-gray-200">Förderwürdig</button>
            <button
                class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200 whitespace-nowrap transition-colors flex-shrink-0 border border-gray-200">Förderfähig</button>
            <button
                class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200 whitespace-nowrap transition-colors flex-shrink-0 border border-gray-200">Option
                1</button>
            <button
                class="px-3 py-1.5 text-xs font-medium text-gray-700 bg-gray-100 rounded-full hover:bg-gray-200 whitespace-nowrap transition-colors flex-shrink-0 border border-gray-200">Option
                2</button>
        </div>

        <!-- Chat Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 pb-20">
            {% if chat_history %}
            {% for msg in chat_history %}
            {% include "partials/chat_message.html" with context %}
            {% endfor %}
            {% else %}
            <div class="flex w-full justify-start">
                <div
                    class="max-w-[85%] rounded-lg px-4 py-2 shadow-sm bg-white border border-gray-200 text-gray-800 rounded-bl-none prose prose-sm">
                    {{ greeting_message }}
                </div>
            </div>
            {% endif %}

            <!-- Thinking Indicator -->
            <div id="thinking-indicator" class="htmx-indicator flex w-full justify-start">
                <div
                    class="max-w-[85%] rounded-lg px-4 py-2 shadow-sm bg-white border border-gray-200 text-gray-500 rounded-bl-none flex items-center gap-2">
                    <svg class="animate-spin h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    <span class="text-sm">Analysiere...</span>
                </div>
            </div>
        </div>

        <!-- Chat Input -->
        <div class="absolute bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 z-10">
            <form hx-post="/projects/{{ project.id }}/chat" hx-target="#chat-messages" hx-swap="beforeend"
                hx-indicator="#thinking-indicator"
                hx-on::after-request="this.reset(); document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;">
                <div class="relative rounded-md shadow-sm">
                    <input type="text" name="message"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm py-3 pl-4 pr-12"
                        placeholder="Frage zum Antrag stellen..." autocomplete="off" required>
                    <div class="absolute inset-y-0 right-0 flex items-center">
                        <button type="submit"
                            class="inline-flex items-center justify-center p-2 rounded-full text-primary-600 hover:text-primary-700 hover:bg-primary-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 mx-1">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- VIEW 2: CRITERIA CATALOG (New Implementation) -->
    <div x-show="activeView === 'catalog'" class="flex-1 flex flex-col h-full overflow-hidden bg-gray-50/50"
        x-transition:enter="transition ease-out duration-300"
        x-transition:enter-start="opacity-0 transform translate-x-8"
        x-transition:enter-end="opacity-100 transform translate-x-0" style="display: none;">

        <!-- Catalog Action Bar -->
        <div class="px-6 py-4 bg-white border-b border-gray-200 flex justify-end">
            <button
                class="text-sm text-primary-600 font-medium hover:text-primary-700 flex items-center gap-1 transition-colors"
                @click="criteria.forEach(c => c.checked = true)">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                </svg>
                Alle Kriterien bestätigen
            </button>
        </div>

        <!-- 2-Column Grid Layout -->
        <div class="flex-1 overflow-y-auto p-6">
            <div class="grid grid-cols-1 xl:grid-cols-2 gap-4">

                <template x-for="item in criteria" :key="item.id">
                    <div class="bg-white rounded-lg border p-4 transition-all duration-200 hover:shadow-md relative group flex flex-col"
                        :class="{
                            'border-green-200 bg-green-50/20': item.status === 'success',
                            'border-yellow-200 bg-yellow-50/20': item.status === 'warning',
                            'border-gray-200 bg-white': item.status === 'pending'
                         }">

                        <!-- Header Line -->
                        <div class="flex justify-between items-start mb-2">
                            <span
                                class="inline-flex items-center rounded-md px-2 py-1 text-xs font-bold ring-1 ring-inset"
                                :class="{
                                    'bg-green-100 text-green-700 ring-green-600/20': item.status === 'success',
                                    'bg-yellow-100 text-yellow-800 ring-yellow-600/20': item.status === 'warning',
                                    'bg-gray-100 text-gray-600 ring-gray-500/10': item.status === 'pending'
                                  }" x-text="item.id">
                            </span>

                            <div class="flex items-center gap-2">
                                <!-- Status Text -->
                                <span class="text-xs font-semibold flex items-center gap-1" :class="{
                                        'text-green-700': item.status === 'success',
                                        'text-yellow-800': item.status === 'warning',
                                        'text-gray-500': item.status === 'pending'
                                      }">
                                    <span x-show="item.status === 'success'">✓</span>
                                    <span x-show="item.status === 'warning'">⚠</span>
                                    <span x-text="item.statusText"></span>
                                </span>

                                <!-- Restart Button -->
                                <button
                                    class="p-1 text-gray-400 hover:text-primary-600 hover:bg-gray-100 rounded-full transition-colors"
                                    title="Neu prüfen">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15">
                                        </path>
                                    </svg>
                                </button>
                            </div>
                        </div>

                        <!-- Content -->
                        <h4 class="font-semibold text-gray-900 text-sm mb-1" x-text="item.title"></h4>
                        <p class="text-xs text-gray-600 leading-relaxed mb-4 flex-1" x-text="item.desc"></p>

                        <!-- Manual Confirmation Checkbox -->
                        <div class="mt-2 pt-3 border-t border-gray-100/50 flex items-center gap-2">
                            <input type="checkbox" :id="'check-' + item.id" x-model="item.checked"
                                class="rounded border-gray-300 text-primary-600 focus:ring-primary-500 h-4 w-4 cursor-pointer">
                            <label :for="'check-' + item.id"
                                class="text-xs text-gray-600 select-none cursor-pointer">Manuell geprüft</label>
                        </div>
                    </div>
                </template>

            </div>

            <!-- Bottom Spacer -->
            <div class="h-24"></div>
        </div>

        <!-- Finish Review Button (Sticky Bottom) -->
        <div
            class="p-6 bg-white border-t border-gray-200 absolute bottom-0 left-0 right-0 z-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
            <button @click="showConfirmation = true"
                class="w-full flex items-center justify-center gap-2 px-4 py-3 bg-primary-600 hover:bg-primary-700 text-white rounded-lg font-semibold shadow-sm transition-all transform hover:scale-[1.01] focus:ring-4 focus:ring-primary-100">
                <span>Antrag abschließen</span>
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
            </button>
        </div>
    </div>

    <!-- DOUBLE CONFIRMATION MODAL -->
    <template x-teleport="body">
        <div x-show="showConfirmation" class="fixed inset-0 z-[100] overflow-y-auto" aria-labelledby="modal-title"
            role="dialog" aria-modal="true" style="display: none;">

            <!-- Backdrop -->
            <div x-show="showConfirmation" x-transition:enter="ease-out duration-300"
                x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100"
                x-transition:leave="ease-in duration-200" x-transition:leave-start="opacity-100"
                x-transition:leave-end="opacity-0"
                class="fixed inset-0 bg-gray-900/75 backdrop-blur-sm transition-opacity"></div>

            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div x-show="showConfirmation" @click.outside="showConfirmation = false"
                    x-transition:enter="ease-out duration-300"
                    x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                    x-transition:leave="ease-in duration-200"
                    x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                    x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                    class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg border border-gray-100">

                    <div class="bg-white px-4 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="sm:flex sm:items-start">
                            <div
                                class="mx-auto flex h-12 w-12 flex-shrink-0 items-center justify-center rounded-full bg-green-100 sm:mx-0 sm:h-10 sm:w-10">
                                <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                    stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                </svg>
                            </div>
                            <div class="mt-3 text-center sm:ml-4 sm:mt-0 sm:text-left">
                                <h3 class="text-lg font-bold leading-6 text-gray-900" id="modal-title">Prüfung
                                    abschließen</h3>
                                <div class="mt-2 text-left">
                                    <p class="text-sm text-gray-500 mb-4">
                                        Achtung: Dies ist eine verbindliche Bestätigung der Antragsbearbeitung.
                                    </p>
                                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-3 mb-4">
                                        <div class="flex">
                                            <div class="ml-1">
                                                <p class="text-xs text-yellow-700 font-medium">
                                                    Bitte bestätigen Sie, dass alle Kriterien sorgfältig geprüft wurden
                                                    und der Antrag zur finalen Entscheidung freigegeben werden kann.
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Warning Checkbox Area -->
                    <div class="bg-gray-50 px-4 py-3 sm:flex sm:flex-col sm:px-6 gap-3">
                        <div class="flex items-center gap-2 mb-2 p-3 bg-white border border-gray-200 rounded hover:bg-gray-50 transition-colors cursor-pointer"
                            onclick="document.getElementById('confirm-final').click()">
                            <input type="checkbox" id="confirm-final"
                                class="rounded border-gray-300 text-primary-600 focus:ring-primary-500 h-4 w-4"
                                required>
                            <label for="confirm-final"
                                class="text-sm text-gray-700 font-medium cursor-pointer select-none">Ich bestätige die
                                vollständige Prüfung</label>
                        </div>

                        <div class="flex flex-row-reverse gap-2 w-full mt-2">
                            <button type="button" @click="confirmReview()" id="btn-finish"
                                class="inline-flex w-full justify-center rounded-md bg-primary-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-primary-500 sm:ml-3 sm:w-auto transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                                Ja, Prüfung abschließen
                            </button>
                            <button type="button" @click="showConfirmation = false"
                                class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 sm:mt-0 sm:w-auto transition-colors">
                                Abbrechen
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>
</div>