{% extends "base.html" %}

{% block title %}IFB Chat{% endblock %}

{% block content %}
<div class="flex h-full">
    <!-- Sidebar -->
    <div class="w-64 bg-white border-r border-gray-200 p-4 hidden md:block overflow-y-auto">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">System Status</h2>

        {% include "components/system_status.html" %}

        <div class="mt-8">
            <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider mb-2">Tips</h3>
            <ul class="text-sm text-gray-600 space-y-2">
                <li>• Ask specific questions</li>
                <li>• Reference document sections</li>
                <li>• Check sources for verification</li>
            </ul>
        </div>
    </div>

    <!-- Chat Area -->
    <div class="flex-1 flex flex-col bg-gray-50">
        <!-- Header (Issue 8) -->
        <div class="px-4 py-3 bg-white border-b border-gray-200 flex justify-between items-center shadow-sm z-10">
            <h1 class="text-lg font-semibold text-gray-800">Global Chat</h1>
            {% if model_name %}
            <span
                class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                Modell: {{ model_name }}
            </span>
            {% endif %}
        </div>

        <!-- Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4">
            {% if chat_history %}
            {% for msg in chat_history %}
            {% include "partials/chat_message.html" with context %}
            {% endfor %}
            {% else %}
            <div class="text-center text-gray-500 mt-8">
                <p class="text-lg font-medium">{{ greeting_message }}</p>
            </div>
            {% endif %}
            <div id="thinking-indicator" class="htmx-indicator flex w-full justify-start mt-2">
                <div
                    class="max-w-[85%] rounded-lg px-4 py-2 shadow-sm bg-white border border-gray-200 text-gray-500 rounded-bl-none flex items-center gap-2">
                    <svg class="animate-spin h-4 w-4 text-gray-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                        viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4">
                        </circle>
                        <path class="opacity-75" fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                        </path>
                    </svg>
                    <span class="text-sm">Analysiere...</span>
                </div>
            </div>
        </div>

        <!-- Input Area -->
        <div class="bg-white border-t border-gray-200 p-4">
            <form hx-post="/chat/query" hx-target="#chat-messages" hx-swap="beforeend"
                hx-indicator="#thinking-indicator"
                hx-on::after-request="this.reset(); document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;">

                <div class="relative rounded-md shadow-sm max-w-4xl mx-auto">
                    <input type="text" name="question"
                        class="block w-full rounded-md border-gray-300 shadow-sm focus:border-primary-500 focus:ring-primary-500 sm:text-sm py-3 pl-4 pr-12"
                        placeholder="Wie kann ich helfen?" required autocomplete="off">
                    <div class="absolute inset-y-0 right-0 flex items-center">
                        <button type="submit"
                            class="inline-flex items-center justify-center p-2 rounded-full text-primary-600 hover:text-primary-700 hover:bg-primary-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500 mx-1">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.body.addEventListener('htmx:afterSwap', function (evt) {
        if (evt.detail.target.id === 'chat-messages') {
            // Scroll to bottom
            const container = document.getElementById('chat-messages');
            container.scrollTop = container.scrollHeight;

            // Clear input
            const input = document.querySelector('input[name="question"]');
            if (input) input.value = '';
        }
    });
</script>
{% endblock %}